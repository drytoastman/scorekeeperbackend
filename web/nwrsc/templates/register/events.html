{% extends "register/bluebase.html" %}
{% import 'common/macros.html' as m %}
{% import 'register/macros.html' as rm %}

{% block headers %}
{{super()}}
<script type="text/javascript" src="https://js.squareup.com/v2/paymentform"></script>
<script type="text/javascript">

{% if sqappid %}
var applicationId = '{{sqappid}}';
try {
  var paymentForm = new SqPaymentForm({
      applicationId:  applicationId,
      inputClass:     'sq-input',
      inputStyles:    [ { fontSize: '15px', lineHeight: '23px' } ],
      cardNumber:     { elementId: 'sq-card-number',     placeholder: '.... .... .... ....' },
      cvv:            { elementId: 'sq-cvv',             placeholder: 'CVV' },
      expirationDate: { elementId: 'sq-expiration-date', placeholder: 'MM/YY' },
      postalCode:     { elementId: 'sq-postal-code' },
      // Payment form callback functions
      callbacks: {
        unsupportedBrowserDetected: function() { alert('Browser not supported for square payments'); },
        cardNonceResponseReceived: function(errors, nonce, cardData) {
          if (errors) {
            console.log(errors);
          } else {
            $('#squareform input[name=nonce]').val(nonce);
            eventRelativeSubmit($('#squareform'));
          }
        },
      }
  });
} catch (e) {
    console.log("Square not available:" + e);
}

{% endif %}

// Submit change requests/payments via AJAX and then update the event section separately
function eventRelativeSubmit(form)
{
    form.closest('.modal').modal('hide');
    var eventid = form.find('input[name=eventid]').val();
    var targetdiv = $('#eventtog'+eventid);
    var sheight = targetdiv.height();
    targetdiv.html('<i class="fa fa-spinner fa-pulse fa-3x fa-fw text-center"></i>');
    targetdiv.height(sheight);

    $.ajax({
        dataType: "html",
        url: form.attr('action'),
        data: form.serialize(),
        method: 'POST',
        success: function(data) { targetdiv.html(data); },
        error: function(xhr, stat, error) { targetdiv.html('<div class="error">'+xhr.responseText+'</div>'); },
        complete: function(xhr) { targetdiv.height('auto'); }
        });
}

$(document).ready(function() { 
    $('[id^=eventtog]').each(function (ii, val) {
        add_collapse_icons('#'+this.id); 
    });

    $('#squaremodal').on('show.bs.modal', function (e) {
        var button = $(e.relatedTarget) // Button that triggered the modal
        initsquareform('#squareform', button.data('eventid'));
    });

    $('#squareform input[type=submit]').click(function (e) {
        e.preventDefault();
        paymentForm.requestCardNonce();
    });

    $('#squareform select[name=amount], #squareform select[name=count]').change(function () {
        var form = $('#squareform');
        var total = form.find('select[name=amount]').val() * form.find('select[name=count]').val();
        form.find('.total').html('$'+total.toFixed(2));
    })

    $('#registermodal').on('show.bs.modal', function (e) {
        var button = $(e.relatedTarget) // Button that triggered the modal
        initregform('#registerform', button.data('eventid'), button.data('limit'), button.data('msg'))
    });

    $('#registerform input[type=submit]').click(function (e) {
        e.preventDefault();
        eventRelativeSubmit($('#registerform'));
    });
});


function initsquareform(id, eventid)
{
    var me = $(id);
    me.find('input[name=eventid]').val(eventid);
    paymentForm.setPostalCode('{{g.driver.attr.zip}}');
    costs = gCosts[eventid].options;
    options = [];
    for (key in costs) {
        options.push($('<option/>').val(costs[key]).text(key));
    }
    me.find('select[name=amount]').empty().append(options);
    me.find('select[name=count]').val(1).change();
}

function initregform(id, eventid, limit, msg)
{
    var me = $(id);
    var checkmax = function() {
        var dodisable = (me.find(":checked").length >= limit);
        me.find('input[type=checkbox]:unchecked').prop('disabled', dodisable);
        me.find('.statuslabel').html( dodisable && msg || "");
    };

    me.find('input[name=eventid]').val(eventid);
    me.find('input[type=checkbox]').prop('checked', false).prop('disabled', false).click(checkmax);
    gRegistered[eventid].forEach(function (regentry) {
        me.find("input[name="+regentry.carid+"]").prop('checked', true);
    });

    checkmax();
}

var gRegistered = Array();
var gCosts = Array();
</script>
{% endblock headers %}


{% block content %}
{{super()}}

<div id='eventsouter'>
<div id='eventscontainer' class='container'>
    <div class='title'>Events in {{g.seriesname}}</div>
{% for ev in events %}
    {% set eclass = ev.isOpen() and "eventopen show" or "eventclosed" %}
    <div class='eventheader {{eclass}} row justify-content-start'>
        <a data-toggle='collapse' href='#eventtog{{ev.eventid}}'>
        <span class='fa'></span>
        <span class='eventdate'>{{ev.date.strftime('%a %b %d')}}</span>
        <span class='eventname'>{{ev.name}}</span>
        </a>
    </div>

    <div id='eventtog{{ev.eventid}}' data-eventid='{{ev.eventid}}' class='eventholder {{eclass}} collapse row'>
    {{rm.eventdisplay(ev, cars, registered[ev.eventid], payments[ev.eventid], accounts[ev.eventid])}}
    </div>

{% endfor %}
</div>
</div>

{% call m.modal('registermodal', 'Register Cars', '') %}
    <form id='registerform' action='{{url_for(".eventspost")}}' method='POST'>
        <input type='hidden' name='eventid' value=''/>
        <div class='row'>
        <div class='col-2'></div>
        <div class='col-10'><a href='cars'><span class='fa fa-car'></span>Create,Edit and Delete Cars Here</a></div>
        </div>
        {% for c in cars.values() %}
        <div class='row align-items-center'>
        <input class="col-2" name="{{c.carid}}" type="checkbox" value="y"/>
        <label class="col-10" for="{{c.carid}}">{{rm.carDisplay(c)}}</label>
        </div>
        {% endfor %}
        <div class='row mt-2'>
        <div class='col text-center'><span class='statuslabel error'></span></div>
        </div>
        <div class='row'>
        <div class='col'><input id='regupdatebutton' type='submit' class='btn btn-register' value='Update'/></div>
        </div>
    </form>
{% endcall %}

{% call m.modal('paypalmodal', 'Payment', '') %}
    Put paypal stuff here someday
{% endcall %}

{% call m.modal('squaremodal', 'Payment', '') %}
    <form id='squareform' action='{{url_for(".square")}}' method='POST'>
        {{sqform.nonce()}}
        {{sqform.eventid()}}
        {{sqform.csrf_token()}}
        <img src="/static/images/squarelogo.svg"/>
        <div class='row'><label class='col-md-4'>Card Number</label>    <div class='col-md-8 p-0'><div id="sq-card-number"></div></div></div>
        <div class='row'><label class='col-md-4'>CVV</label>            <div class='col-md-8 p-0'><div id="sq-cvv"></div></div></div>
        <div class='row'><label class='col-md-4'>Expiration Date</label><div class='col-md-8 p-0'><div id="sq-expiration-date"></div></div></div>
        <div class='row'><label class='col-md-4'>Postal Code</label>    <div class='col-md-8 p-0'><div id="sq-postal-code"></div></div></div>
        <div class='row'><label class='col-md-4'>Type</label>           <div class='col-md-8 p-0'><select name='amount'>{# dynamic #}</select></div></div>
        <div class='row'><label class='col-md-4'>Count</label>          <div class='col-md-8 p-0'>{{sqform.count()}}</div></div>
        <div class='row'><label class='col-md-4'>Total</label>          <div class='col-md-8 p-0 total'>$0.00</div></div>
        <div class='row'><div class='col p-0'><input id='regpaybutton' type='submit' class='btn btn-register' value='Pay'/></div></div>
    </form>
{% endcall %}

{% endblock content %}

