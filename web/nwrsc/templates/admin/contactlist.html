{% extends "admin/bluebase.html" %}
{% import "common/macros.html" as m %}

{% block headers %}
{{super()}}
<style type="text/css">
textarea {
    height: 30rem;
}
ul {
    columns: 5;
    list-style: none;
    white-space: nowrap;
    margin: 0;
}
ul input {
    height: 1.2rem;
    width: 1.2rem;
    vertical-align: middle;
}
.dt-buttons { margin-left: 1rem; }
</style>
<script>
var emailregex = /^([a-zA-Z0-9_.+-])+\@(([a-zA-Z0-9-])+\.)+([a-zA-Z0-9]{2,4})+$/;
var thetable   = null;
var matchtypes = [];
var matchevent = []

$.fn.dataTable.ext.search.push(
    function (settings, data, dataIndex) {
        if ((matchevent.length == 0) || (matchtype == undefined)) return true;
        switch (matchtype) 
        {
            case "reg":
                for (var ii = 0; ii < matchevent.length; ii++)
                    if (data[4].includes(matchevent[ii]))
                        return true;
                break;
            case "run":
                for (var ii = 0; ii < matchevent.length; ii++)
                    if (data[3].includes(matchevent[ii])) 
                        return true;
                break;
            case "noshow":
                for (var ii = 0; ii < matchevent.length; ii++)
                    if (data[4].includes(matchevent[ii]) && !(data[3].includes(matchevent[ii])))
                        return true;
                break;
        } 
        return false;
    }
);


$(document).ready(function(){
	thetable = $('#contacttable').DataTable({ 
        ajax: { url:"{{url_for(".activitylist")}}", dataSrc: ''},
        lengthMenu: [[15, 30, 50, -1], [15, 30, 50, "All"]],
        iDisplayLength: -1,
        autoWidth: false,
        buttons: [
            {
                extend: 'copyHtml5',
                className: 'btn btn-outline-admin',
                text: 'Copy Valid Email',
                title: '',
                header: false, 
                exportOptions: { 
                    columns: ':visible',
                    rows: function (row, data) { return (!data.optoutmail && data.email.match(emailregex)); },
                    format: { body: function (data, row, column, node) {
                            if (column == 0) { return '"'+data; }
                            if (column == 1) { return data+'"'; }
                            if (column == 2) { return '<'+data+'>'; }
                            return '';
                        }
                    } 
                },
                customize: function (output) {
                    return output.replace(/\t/g,' ').replace(/\r?\n|\r/g,', ');
                }
            },
            {   
                extend: 'csvHtml5',  
                className: 'btn btn-outline-admin', 
                text: 'Export To CSV', 
                title: 'contactlist', 
                exportOptions: { columns: ':visible'}
            }
        ],
        columns: [
            { data: 'firstname', width: '30%' },
            { data: 'lastname',  width: '30%' },
            { data: 'email',     width: '40%', render: displayemail },
            { data: 'runs',      width: '0%', visible: false },
            { data: 'reg',       width: '0%', visible: false }
        ],
        sDom: '<"dtheader"fiB>rt<"clear">'
    });

    // mutually exclusive filtertype
    $('ul input[name=filtertype]').change(function () {
        if ($(this).prop('checked')) {
            $('ul input[name=filtertype]').not(this).prop('checked', false);
        }
    });

    $('ul input[type=checkbox]').change(function () {
        matchtype  = $('ul input[name=filtertype]:checked').val();
        matchevent = $('ul input[name=event]:checked').map(function () { return $(this).data('event'); });
        thetable.draw();
    });
});
</script>
{% endblock headers %}

{% block content %}
{{super()}}
<div class='container'>
<h3>Contact List</h3>
<p>The default list is of anyone who has registered or run in the series.  Use the checkboxes to select filters and/or type text into the search box.</p>
<h6>Filter Type</h6>
<ul>
    <li><input type="checkbox" name="filtertype" value="reg"/>Registered In</li>
    <li><input type="checkbox" name="filtertype" value="run"/>Ran In</li>
    <li><input type="checkbox" name="filtertype" value="noshow"/>Registered But Didn't Run</li>
</ul>
<h6>For Events</h6>
<ul>
{% for e in events %}
    <li><input data-event="{{e.eventid}}" name="event" type="checkbox"/>{{e.name}}</li>
{% endfor %}
</ul>
<br/>

<table id='contacttable' class='table-striped table-bordered' cellspacing="0" width="100%">
<thead>
<tr><th>First</th><th>Last</th><th>Email</th></tr>
</thead>
<tbody>
</table>
</div>

{% call m.modal('contactmodal', 'Email List', '', 'modal-lg') %}
<div class='row'>
<textarea class='col'>
</textarea>
</div>
{% endcall %}

{% endblock content %}

