{% extends "admin/abase.html" %}
{% import "common/macros.html" as m %}

{% block headers %}
{{super()}}
<style type="text/css">

.dataTables_wrapper {
    display: block;
}
.dtheader div {
    display: inline-block;
}
.validwrapper {
    margin-left: 1rem;
}
.dataTable {
    margin: auto;
}
th {
    height: 2.5rem;
}
textarea {
    width: 60rem;
    height: 30rem;
}
ul {
    columns: 5;
    list-style: none;
    white-space: nowrap;
    margin: 0;
}
ul input {
    height: 1.2rem;
    width: 1.2rem;
    vertical-align: middle;
}
</style>
<script>
var emailregex = /^([a-zA-Z0-9_.+-])+\@(([a-zA-Z0-9-])+\.)+([a-zA-Z0-9]{2,4})+$/;
var thetable   = null;
var matchrun   = [];
var matchreg   = []

function copyemail()
{
    $("#contactmodal textarea").val(extractemail());
    $("#contactmodal").modal('show');
}

function extractemail()
{
    var ret = Array();
    var data = thetable.rows({filter: 'applied'}).data();
    for (var ii= 0; ii < data.length; ii ++) {
        if (data[ii].email.match(emailregex))
            ret.push(data[ii].email);
    }
    return ret;
}

$.fn.dataTable.ext.search.push(
    function (settings, data, dataIndex) {
        if ((matchrun.length == 0) && (matchreg.length == 0)) return true;
        for (var ii = 0; ii < matchrun.length; ii++) if (data[3].includes(matchrun[ii])) return true;
        for (var ii = 0; ii < matchreg.length; ii++) if (data[4].includes(matchreg[ii])) return true;
        return false;
    }
);

$(document).ready(function(){
	thetable = $('#contacttable').DataTable({ 
        ajax: { url:"{{url_for(".activitylist")}}", dataSrc: ''},
        lengthMenu: [[15, 30, 50, -1], [15, 30, 50, "All"]],
        iDisplayLength: -1,
        autoWidth: false,
        columns: [
            { data: 'firstname', width: '30%' },
            { data: 'lastname',  width: '30%' },
            { data: 'email',     width: '40%' },
            { data: 'runs',      width: '0%', visible: false },
            { data: 'reg',       width: '0%', visible: false }
        ],
        sDom: '<"dtheader"fi>rt<"clear">'
    });

    $('.dtheader').append("<div class='validwrapper'><button class='btn btn-outline-success' onclick='copyemail()'>Copy Valid Email</button></div>");

    $('input[type=checkbox]').change(function () {
        matchrun = $('ul input[data-type="run"]:checked').map(function () { return $(this).data('event'); });
        matchreg = $('ul input[data-type="reg"]:checked').map(function () { return $(this).data('event'); });
        thetable.draw();
    });
});
</script>
{% endblock headers %}

{% block content %}
{{super()}}
<div class='container'>
<h2>Contact List</h2>
<h5>
Ran in 
</h5>
<ul>
{% for e in events %}
    <li><input data-type="run" data-event="{{e.eventid}}" type='checkbox'/>{{e.name}}</li>
{% endfor %}
</ul>
<h5>Registered in</h5>
<ul>
{% for e in events %}
    <li><input data-type="reg" data-event="{{e.eventid}}" type='checkbox'/>{{e.name}}</li>
{% endfor %}
</ul>
<br/>

<table id='contacttable' class='table-striped table-bordered' cellspacing="0" width="100%">
<thead>
<tr><th>First</th><th>Last</th><th>Email</th></tr>
</thead>
<tbody>
</table>
</div>

{% call m.modal('contactmodal', 'Email List', '') %}
<div class='row'>
<textarea class='col'>
</textarea>
</div>
{% endcall %}

{% endblock content %}

